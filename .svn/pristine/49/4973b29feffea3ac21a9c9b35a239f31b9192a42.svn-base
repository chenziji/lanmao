using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;
using System.IO;

public class Playing_AI : MonoBehaviour
{
    public static int game_state = 0;   //游戏状态

    public static int game_chick = 0;   //点击次数
    public static int game_chick_right = 0;   //正确操作次数
    public static int game_chick_error = 0;   //错误操作次数

    public static int game_reset = 0;   //重置次数
    public static int game_success = 0; //成功通关次数
    public static float game_AllTime = 0; //所有通关次数所用总时间
    public static int game_Allchick = 0;   //所有通关次数所用总点击次数
    public static int game_Allchick_right = 0;   //所有通关次数所用总点击成功次数
    public static int game_Allchick_error = 0;   //所有通关次数所用总点击失败次数

    public static int gb_prefab_Num = 18;   //预设数量
    public static int gb_playing_Num = 64;  //游戏对象数量

    public static int iReverseA = 0;  //A翻转的ID
    public static int iReverseB = 0;  //B翻转的ID
    public static int iReverseC = 0;  //C翻转的ID
    public static GameObject gb_ReverseA;  //A翻转的对象
    public static GameObject gb_ReverseB;  //B翻转的对象
    public static GameObject gb_ReverseC;  //C翻转的对象

    public static int m_Success = 0;   //成功的个数

    public static string strTime;   //用时

    int m_per_line_num = 8;    //每排数量
    float posx = 0, posy = 0; //初始坐标
    float wight = 86, hight = 83; //单个元素宽高间隔
    IList<int> listRandom = new List<int>(gb_playing_Num);  //随机表

    private GameObject gb_GameObject_father;//父类
    private GameObject[] gb_playing_prefad;//预设
    private GameObject[] gb_playing;//实例

    //其他对象
    public GameObject gb_bt_PlayBegin;
    public GameObject gb_bt_HowToPlay;
    public GameObject gb_bt_PlayMoreGame;
    public GameObject gb_bt_PlayAgain;
    public GameObject gb_bt_PlayMoreEnd;
    public GameObject gb_bt_Reset;

    public static GameObject gb_UI_Main;
    public static GameObject gb_UI_Playing;
    public static GameObject gb_UI_End;

    public GameObject gb_Text_end_Timer;
    public GameObject gb_Text_end_chick;
    public GameObject gb_Text_end_chick_right;
    public GameObject gb_Text_end_chick_error;

    public GameObject gb_bt_logo01;
    public GameObject gb_bt_logo02;
    public GameObject gb_bt_logo03;
    public GameObject gb_bt_logo04;

    string str1 = "";
    string str2 = "Sprite_";
    string str = "";

    // Start is called before the first frame update
    void Start()
    {
        //Screen.SetResolution(640, 960, false);

        gb_bt_PlayBegin = GameObject.Find("main_play");
        gb_bt_HowToPlay = GameObject.Find("main_howtoplay");
        gb_bt_PlayMoreGame = GameObject.Find("main_play_more_game");
        gb_bt_PlayAgain = GameObject.Find("end_play_again");
        gb_bt_PlayMoreEnd = GameObject.Find("end_play_more");
        gb_bt_Reset = GameObject.Find("reset");

        gb_UI_Main = GameObject.Find("main");
        gb_UI_Playing = GameObject.Find("playing");
        gb_UI_End = GameObject.Find("end");

        gb_Text_end_Timer = GameObject.Find("timer2");
        gb_Text_end_chick = GameObject.Find("chick2");
        gb_Text_end_chick_right = GameObject.Find("chick_right2");
        gb_Text_end_chick_error = GameObject.Find("chick_error2");

        gb_bt_logo01 = GameObject.Find("main_logo01");
        gb_bt_logo02 = GameObject.Find("main_logo02");
        gb_bt_logo03 = GameObject.Find("main_logo03");
        gb_bt_logo04 = GameObject.Find("main_logo04");

        gb_UI_Playing.SetActive(false);
        gb_UI_End.SetActive(false);
        gb_bt_PlayAgain.SetActive(false);
        gb_bt_PlayMoreEnd.SetActive(false);
        gb_bt_Reset.SetActive(false);

        gb_Text_end_Timer.SetActive(false);
        gb_Text_end_chick.SetActive(false);
        gb_Text_end_chick_right.SetActive(false);
        gb_Text_end_chick_error.SetActive(false);

        if (gb_UI_Playing)
        {
            gb_UI_Playing.SetActive(false);
        }


        posx = gb_UI_Main.transform.position.x - 460;
        posy = gb_UI_Main.transform.position.y - 295;

        gb_playing_prefad = new GameObject[gb_prefab_Num];

        //预设初始化显示false
        for (int i = 1; i <= gb_prefab_Num; ++i)
        {
            if (i <= 9)
            {
                str1 = "Sprite_0";
                str1 += i.ToString();
                str = str1;
            }
            else
            {
                str2 = "Sprite_";
                str2 += i.ToString();
                str = str2;
            }

            gb_playing_prefad[i - 1] = GameObject.Find(str);
            if (!gb_playing_prefad[i - 1])
            {
                continue;
            }

            //设置激活状态为flase后，该组件不会再被 find
            gb_playing_prefad[i - 1].SetActive(false);
        }
    }

    // Update is called once per frame
    void Update()
    {
        //float horizontal = Input.mousePosition.x;
       // float vertical = Input.mousePosition.y;
        //print("【x】:" + horizontal + "【y】:" + vertical);

        if (game_state == 1)
        {
            if (gb_ReverseA && gb_ReverseB)
            {
                if (iReverseA != 0 && iReverseB != 0 )
                {
                    if (iReverseA != iReverseB)
                    {
                        //没有翻转到同一个
                        gb_ReverseA.GetComponent<Perfab_01>().bEnd = true;
                        gb_ReverseB.GetComponent<Perfab_01>().bEnd = true;
                    }
                    else
                    {
                        //翻转到同一个

                        //播放特效 大约0.5s
                        Effect();

                        ++m_Success;
                        if (m_Success >= gb_playing_Num / 2)
                        //if (m_Success >= 1)
                        {
                            //全部翻盘，结束游戏 //延迟播放特效 大约0.5s
                            Invoke("GameEnd", 0.5f);
                            return;
                        }
                    }
                    Playing_AI.iReverseA = 0;
                    Playing_AI.iReverseB = 0;
                    Playing_AI.gb_ReverseA = null;
                    Playing_AI.gb_ReverseB = null;
                }
            }  
        }
    }

    void Effect()
    {

    }

    public void Init()
    {
        BCI_Socket.Instance.SendMsg("M_Level1Round1");

        gb_GameObject_father = GameObject.Find("GameObject");
        gb_bt_Reset.SetActive(true);

        gb_playing = new GameObject[gb_playing_Num];

        //添加随机数组
        for (int i = 1; i <= gb_playing_Num; ++i)
        {
            listRandom.Add(i);
        }

        int w = 0, h = 0;

        int create_playing_left = gb_playing_Num;
        //从数组中随机2个
        while (listRandom.Count > 0)
        {
            //随机是哪个预设
            int prefabNum = Random.Range(1, gb_prefab_Num);

            for (int num = 0; num < 2; ++num)
            {
                //从数组中剩余元素随机
                //随机到索引
                int index = Random.Range(1, create_playing_left);
                //获取索引值
                index -= 1;
                int irand = listRandom[index];
                //删除随机列表中的元素
                listRandom.RemoveAt(index);
                //计数减1
                --create_playing_left;

                //计算排数x,y
                if (irand % m_per_line_num == 0)
                {
                    h = irand / m_per_line_num;
                }
                else
                {
                    h = irand / m_per_line_num + 1;
                }
                w = irand - (h - 1) * m_per_line_num;

                //从0计数
                --h;
                --w;

                if (!gb_playing_prefad[prefabNum])
                {
                    break;
                }

                //创建实例
                gb_playing[irand - 1] = Instantiate<GameObject>(gb_playing_prefad[prefabNum]);
                if (gb_playing[irand - 1])
                {
                    gb_playing[irand - 1].transform.SetParent(gb_GameObject_father.transform);
                    gb_playing[irand - 1].transform.position = new Vector3(posx + w * wight, posy + h * hight, 0);
                    gb_playing[irand - 1].SetActive(true);
                   // gb_playing[irand - 1].GetComponent<Image>().material = null;
                }
            }
        }
    }

    //关闭程序
    void OnApplicationQuit()
    {
        //游戏结束
        BCI_Socket.Instance.SendMsg("M_End");

        //最后发送的游戏统计信息”Statistics:
        //游戏每关卡重试的次数
        BCI_Socket.Instance.SendMsg("M_Level1RetryTimes:" + game_reset.ToString());

        if (game_success != 0)
        {
            //每关卡平均所用的时间（以秒为单位）
            BCI_Socket.Instance.SendMsg("M_Level1AverageTime:" + (game_AllTime / game_success).ToString());
            //每关卡鼠标的平均点击次数
            BCI_Socket.Instance.SendMsg("M_Level1AverageMouseClickTimes:" + (game_Allchick / game_success).ToString());
            //每关卡牌面匹配正确的平均次数
            BCI_Socket.Instance.SendMsg("M_Level1AverageMatchTimes:" + (game_Allchick_right / game_success).ToString());
            //每关卡牌面匹配错误的平均次数
            BCI_Socket.Instance.SendMsg("M_Level1AverageMisatchTimes:" + (game_Allchick_error / game_success).ToString());
        }
        else
        {
            //每关卡平均所用的时间（以秒为单位）
            BCI_Socket.Instance.SendMsg("M_Level1AverageTime:0");
            //每关卡鼠标的平均点击次数
            BCI_Socket.Instance.SendMsg("M_Level1AverageMouseClickTimes:0");
            //每关卡牌面匹配正确的平均次数
            BCI_Socket.Instance.SendMsg("M_Level1AverageMatchTimes:0");
            //每关卡牌面匹配错误的平均次数
            BCI_Socket.Instance.SendMsg("M_Level1AverageMisatchTimes:0");
        }
       
    }

    void GameEnd()
    {
        Log(true);

        //显示结束UI
        gb_UI_End.SetActive(true);
        //显示button
        gb_bt_PlayAgain.SetActive(true);
        gb_bt_PlayMoreEnd.SetActive(true);
        //隐藏所有游戏对象
        for (int i = 0; i < gb_playing_Num; ++i)
        {
            Destroy(gb_playing[i]);
        }
       
        //隐藏UI
        gb_UI_Playing.SetActive(false);
        gb_bt_Reset.SetActive(false);


        //显示结算
        gb_Text_end_Timer.SetActive(true);
        gb_Text_end_chick.SetActive(true);
        gb_Text_end_chick_right.SetActive(true);
        gb_Text_end_chick_error.SetActive(true);

        gb_Text_end_Timer.GetComponent<Text>().text = strTime;
        gb_Text_end_chick.GetComponent<Text>().text = "总点击次数: " + game_chick.ToString();
        gb_Text_end_chick_right.GetComponent<Text>().text = "正确操作次数: " + game_chick_right.ToString();
        gb_Text_end_chick_error.GetComponent<Text>().text = "错误操作次数: " + game_chick_error.ToString();

        game_state = 0;

        ++game_success;

        game_AllTime += float.Parse(strTime);
        game_Allchick += game_chick;
        game_Allchick_right += game_chick_right;
        game_Allchick_error += game_chick_error;


        //每关卡每回合鼠标的点击次数
        BCI_Socket.Instance.SendMsg("M_Level1Round1MouseClickTimes:" + game_chick.ToString());
        //每关卡每回合牌面匹配正确的次数
        BCI_Socket.Instance.SendMsg("M_Level1Round2MatchTimes:" + game_chick_right.ToString());
        //每关卡每回合牌面匹配错误的次数
        BCI_Socket.Instance.SendMsg("M_Level1Round1MisatchTimes:" + game_chick_error.ToString());

        //游戏通关
        BCI_Socket.Instance.SendMsg("M_GamePass");
    }

    public void GameReset()
    {
        //显示隐藏UI
        gb_UI_Playing.SetActive(false);
        gb_UI_End.SetActive(false);
        gb_UI_Main.SetActive(true);
        //显示隐藏button
        gb_bt_PlayAgain.SetActive(false);
        gb_bt_PlayMoreEnd.SetActive(false);
        gb_bt_PlayBegin.SetActive(true);
        gb_bt_PlayMoreGame.SetActive(true);
        gb_bt_HowToPlay.SetActive(true);
        gb_bt_Reset.SetActive(false);

        //隐藏结算
        gb_Text_end_Timer.SetActive(false);
        gb_Text_end_chick.SetActive(false);
        gb_Text_end_chick_right.SetActive(false);
        gb_Text_end_chick_error.SetActive(false);

        //显示logo
        gb_bt_logo01.SetActive(true);
        gb_bt_logo02.SetActive(true);
        gb_bt_logo03.SetActive(true);
        gb_bt_logo04.SetActive(true);

        //隐藏所有游戏对象
        for (int i = 0; i < gb_playing_Num; ++i)
        {
            Destroy(gb_playing[i]);
        }

        game_state = 0;
    }

    public static void Log(bool b)
    {
        //Application.dataPath 数据路径

        string path = "GameLog日志";            //默认在工程目录下创建
        //创建文件夹
        if (Directory.Exists(path) == false)
        {
            //Directory.CreateDirectory(Application.dataPath + "GameLog日志");   //只有当文件不存在的话，创建新文件
            Directory.CreateDirectory(path);
        }

        //创建txt
        //StreamWriter sw = new StreamWriter(Application.dataPath + "GameLog日志//Log_短时记忆01.txt", true);
        StreamWriter sw = new StreamWriter(path + "//Log_短时记忆01.txt", true);

        GameObject temp = GameObject.Find("timer_begin");

        //开始写入
        sw.WriteLine("");
        sw.WriteLine("短时记忆01  " + System.DateTime.Now.ToString());
        if(b)
        {
            sw.WriteLine("类型: 成功");
        }
        else
        {
            sw.WriteLine("类型: 失败");
        }
        sw.WriteLine("点击次数: " + game_chick);
        sw.WriteLine("用时" + strTime);
        sw.WriteLine("正确操作次数: " + game_chick_right);
        sw.WriteLine("错误操作次数: " + game_chick_error);
        //清空缓冲区
        sw.Flush();
        //关闭流
        sw.Close();
    }
}